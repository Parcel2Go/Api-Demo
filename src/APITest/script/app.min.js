var config={oAuthClientId:"demo",oAuthScope:"public-api%20payment",oAuthReturnUrl:"http%3A%2F%2Flocalhost%3A52981%2F%23%2Ftoken?",endPoints:{auth:"https://www.parcel2go.com/auth",quotes:"https://www.parcel2go.com/api/quotes",countries:"https://www.parcel2go.com/api/countries",customer:"https://www.parcel2go.com/api/me/detail",deliveryAddresses:"https://www.parcel2go.com/api/me/deliveryAddresses",collectionAddresses:"https://www.parcel2go.com/api/me/collectionAddresses",order:"https://www.parcel2go.com/api/orders"}},p2GoApp=angular.module("p2GoApp",["ngRoute","ngAnimate","angular-loading-bar","angular-cache"]);p2GoApp.config(["cfpLoadingBarProvider",function(n){n.parentSelector="#loading-bar-container";n.spinnerTemplate='<div class="bg"><i class="fa fa-spinner animated infinite rotateIn"><\/i><span>Loading...<\/span><\/div>'}]);p2GoApp.config(function(n){n.when("/",{templateUrl:"pages/quote.html",controller:"quoteController"}).when("/token",{templateUrl:"pages/quote.html",controller:"tokenController"}).when("/results",{templateUrl:"pages/results.html",controller:"resultsController"}).when("/parcels",{templateUrl:"pages/parcels.html",controller:"parcelController"}).when("/order",{templateUrl:"pages/order.html",controller:"orderController"}).when("/overview",{templateUrl:"pages/overview.html",controller:"overviewController"})});p2GoApp.service("TokenService",function(){var n=null,t=[],i=function(n){angular.forEach(t,function(t){t(n)})};return{set:function(t){n=t;localStorage.setItem("token",JSON.stringify(n));i(n)},get:function(){return n==null&&localStorage.getItem("token")?n=JSON.parse(localStorage.getItem("token")):n},registerObserverCallback:function(n){t.push(n)},isLoggedIn:function(){return n!=null}}});p2GoApp.service("OrderService",["$rootScope",function(n){var t=null;return{set:function(i){t=i;localStorage.setItem("order",JSON.stringify(i));n.$broadcast("order:updated",t)},get:function(){return t==null?JSON.parse(localStorage.getItem("order")):t}}}]);p2GoApp.factory("p2gDataContext",["TokenService","$http","$q","CacheFactory",function(n,t,i,r){function f(n){n!=null&&(console.log("Using Token",n),t.defaults.headers.common.Authorization="Bearer "+n.token)}function o(n){return t.post(n)}function s(n){return t.get(n)}function h(n){return t.post(config.endPoints.quotes,n)}function c(n){return t.post(config.endPoints.order,n)}function l(){var n=i.defer(),r=(new Date).getTime(),f=config.endPoints.countries;return t.get(config.endPoints.countries,{cache:u}).success(function(t){console.log("Country list resolved: "+((new Date).getTime()-r)+"ms");n.resolve(t)})}function a(){var n=i.defer(),r=(new Date).getTime(),f=config.endPoints.countries;return t.post(config.endPoints.customer,{cache:u}).success(function(t){console.log("Customer details resolved: "+((new Date).getTime()-r)+"ms");n.resolve(t)})}function v(){var n=i.defer(),r=(new Date).getTime(),f=config.endPoints.countries;return t.post(config.endPoints.deliveryAddresses,{cache:u}).success(function(t){console.log("Customer delivery addresses resolved: "+((new Date).getTime()-r)+"ms");n.resolve(t)})}function y(){var n=i.defer(),r=(new Date).getTime(),f=config.endPoints.countries;return t.post(config.endPoints.collectionAddresses,{cache:u}).success(function(t){console.log("Customer collection addresses resolved: "+((new Date).getTime()-r)+"ms");n.resolve(t)})}n.registerObserverCallback(function(n){f(n)});f(n.get());var e={getCountryList:l,getQuote:h,getOrder:c,getCustomerDetails:a,getCustomerDeliveryAddresses:v,getCustomerCollectionAddresses:y,pay:o,labels:s},u=r("localCache",{maxAge:9e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});return e}]);p2GoApp.directive("googleplace",function(){return{scope:{data:"="},link:function(n,t){n.gPlace=new google.maps.places.Autocomplete(t[0],{types:["geocode"]});google.maps.event.addListener(n.gPlace,"place_changed",function(){n.$apply(function(){for(var i,r,e,t,f=n.gPlace.getPlace(),u=0;u<f.address_components.length;u++)for(i=f.address_components[u],r=0;r<i.types.length;r++){e=i.types[r];t=i.long_name.length?i.long_name:i.short_name;switch(e){case"street_number":n.data.Property=t;break;case"route":n.data.Street=t;break;case"postal_town":n.data.Town=t;break;case"administrative_area_level_1":n.data.Locality=t;break;case"administrative_area_level_2":n.data.County=t;break;case"postal_code":n.data.Postcode=t}}n.data.Property&&n.data.Street&&n.data.Postcode?(n.data.State.View=null,n.data.State.HasAddress=!0):n.data.State.View="Edit"})})}}});p2GoApp.directive("address",["TokenService","p2gDataContext",function(n,t){return{restrict:"AE",scope:{data:"=",header:"@",delivery:"@"},templateUrl:"/pages/templates/address.html",link:function(n){n.data.State=n.data.Property&&n.data.Street&&n.data.Postcode?{View:null,HasAddress:!0}:{View:"Search",HasAddress:!1};n.gatherAddressOptions=function(){n.delivery==="true"?t.getCustomerDeliveryAddresses().success(function(t){n.setAddressOptions(t)}):t.getCustomerCollectionAddresses().success(function(t){n.setAddressOptions(t)})};n.setAddressOptions=function(t){var r,i;for(n.data.State.AddressCollection=t,r=0;r<n.data.State.AddressCollection.length;r++)i=n.data.State.AddressCollection[r],i.Id=r,i.Label=i.Name+" "+i.Property+" "+i.Street+" "+i.Postcode};n.gatherAddressOptions();n.edit=function(){n.data.State.HasAddress=!1;n.data.State.View="Edit"};n.search=function(){n.data.State.HasAddress=!1;n.data.State.View="Search"};n.done=function(){n.data.State.View=null;n.data.Property&&n.data.Street&&n.data.Postcode&&n.data.County&&(n.data.State.HasAddress=!0)};n.$watch("data.State.SelectedAddress",function(){if(n.data.State.SelectedAddress!==undefined){var t=n.data.State.AddressCollection[n.data.State.SelectedAddress];n.data.ContactName=t.Name;n.data.Property=t.Property;n.data.Street=t.Street;n.data.Town=t.Town;n.data.Locality=t.Locality;n.data.County=t.County;n.data.Country=t.Country;n.data.Email=t.Email;n.data.Phone=t.Phone;n.data.Organisation=t.Organisation;n.data.Postcode=t.Postcode;n.data.State=n.data.Property&&n.data.Street&&n.data.Postcode&&n.data.County?{View:null,HasAddress:!0}:{View:"Edit",HasAddress:!1}}})}}}]);p2GoApp.directive("sidebar",[function(){return{restrict:"AE",templateUrl:"/pages/templates/sidebar.html",scope:!0,replace:!0,controller:function(n){n.order.Service.Service.CollectionType==="Collection"&&setInterval(function(){var i=moment(new Date),r=moment(n.order.Service.CutOff),t=moment.duration(r.diff(i));n.$apply(function(){n.cutOff=t.hours()+":"+t.minutes()+":"+t.seconds()})},1e3)}}}]);p2GoApp.directive("counter",[function(){return{require:"ngModel",link:function(n,t,i,r){function u(n,t){this.target=t;this.max=n;this.interval=n/100;this.current=0;var i=this;this.increment=function(){i.target.text((i.current+=i.interval).toFixed(2));i.current<i.max?setTimeout(i.increment,10):i.target.text(i.max.toFixed(2))};setTimeout(i.increment,50)}n.$watch(function(){return r.$modelValue},function(){r.$modelValue&&new u(parseFloat(r.$modelValue),t)})}}}]);p2GoApp.controller("tokenController",["TokenService","$location",function(n,t){var i={token:t.search().access_token,expires:t.search().expires_in,scope:t.search().scope};n.set(i);t.url(t.path());t.path("/")}]);p2GoApp.controller("resultsController",["OrderService","$scope","$location","p2gDataContext",function(n,t,i,r){t.loading=!0;t.order=n.get();t.order.Quote.Service=undefined;t.order&&t.order.Quote||i.path("/quote");r.getQuote(t.order.Quote).success(function(n){t.order.Results.Quotes=[];angular.forEach(n.Quotes,function(n){n.AvailableExtras&&angular.forEach(n.AvailableExtras,function(t){t.Type==="ExtendedBaseCover"&&(n.TotalPriceWithCover=n.TotalPrice+t.Total,n.TotalPriceWithCoverExVat=n.TotalPriceExVat+t.Price)});t.order.Results.Quotes.push(n)});t.loading=!1});t.placeOrder=function(r,u){t.order.Service=r;t.order.Quote.Service=r.Service.Slug;t.order.Quote.Upsells=[];u&&t.order.Quote.Upsells.push("ExtendedBaseCover");n.set(t.order);i.path("/parcels")}}]);p2GoApp.controller("mainController",["TokenService","OrderService","$scope","$location","p2gDataContext",function(n,t,i,r,u){i.$on("cfpLoadingBar:started",function(){$("#loading-bar-container").removeClass("hidden")});i.$on("cfpLoadingBar:completed",function(){$("#loading-bar-container").addClass("hidden")});i.signIn=function(){window.location.href=config.endPoints.auth+"/connect/authorize?response_type=token&redirect_uri="+config.oAuthReturnUrl+"&client_id="+config.oAuthClientId+"&scope="+config.oAuthScope+"&state=oauth2"};i.signOut=function(){n.set(null);i.name=null};i.getName=function(){setTimeout(function(){u.getCustomerDetails().success(function(n){i.name=n.Forename}).error(function(n){console.log(n);i.signIn()})},1e3)};n.registerObserverCallback(function(n){n!=null?i.getName():r.path("/")});n.isLoggedIn&&i.getName()}]);p2GoApp.controller("parcelController",["OrderService","$scope","$location",function(n,t,i){t.order=n.get();var r=function(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t=="x"?i:i&3|8).toString(16)})};t.nextStep=function(){t.order.Order={Items:[{Parcels:[]}]};t.order.Order.Items[0].Id=r();t.order.Order.Items[0].Service=t.order.Service.Service.Slug;t.order.Order.Items[0].CollectionAddress={};t.order.Order.Items[0].CollectionAddress.Postcode=t.order.Quote.CollectionAddress.Postcode;t.order.Order.Items[0].CollectionAddress.CountryIsoCode=t.order.Quote.CollectionAddress.Country;for(var u=0;u<t.order.Quote.Parcels.length;u++)t.order.Order.Items[0].Parcels.push(t.order.Quote.Parcels[u]),t.order.Order.Items[0].Parcels[u].DeliveryAddress={},t.order.Order.Items[0].Parcels[u].DeliveryAddress.Postcode=t.order.Quote.DeliveryAddress.Postcode,t.order.Order.Items[0].Parcels[u].DeliveryAddress.CountryIsoCode=t.order.Quote.DeliveryAddress.Country;n.set(t.order);i.path("/order")}}]);p2GoApp.controller("orderController",["OrderService","$scope","$location","p2gDataContext",function(n,t,i,r){t.order=n.get();t.customerDetails=function(){r.getCustomerDetails().success(function(n){t.order.Order.CustomerDetails={};t.order.Order.CustomerDetails.Forename=n.Forename;t.order.Order.CustomerDetails.Surname=n.Surname;t.order.Order.CustomerDetails.Email=n.Email})};t.placeOrder=function(){n.set(t.order);i.path("/overview")};t.customerDetails()}]);p2GoApp.controller("quoteController",["OrderService","$scope","$location","p2gDataContext",function(n,t,i,r){var u=n.get();t.quote=u&&u.Quote?u.Quote:{CollectionAddress:{Country:"GBR",Postcode:"DN37 9QS"},DeliveryAddress:{Country:"GBR",Postcode:"LL28 5NE"},Parcels:[{Weight:2.4}]};t.countries={};t.loadCountries=function(){r.getCountryList().success(function(n){t.countries=n})};t.getQuote=function(){var r={Quote:t.quote,Results:{},Service:{}};r.Quote.Service=null;n.set(r);i.path("/results")};t.addParcel=function(){t.quote.Parcels.push({})};t.removeParcel=function(n){t.quote.Parcels.splice(n,1)};t.loadCountries()}]);p2GoApp.controller("overviewController",["OrderService","$scope","$location","p2gDataContext",function(n,t,i,r){t.order=n.get();t.order.Overview=null;t.loading=!0;r.getOrder(t.order.Order).success(function(i){t.order.Overview=i;n.set(t.order);t.loading=!1});t.pay=function(){t.loading=!0;r.pay(t.order.Overview.Links.PayWithPrePay).success(function(i){t.order.Payment=i;n.set(t.order);t.loading=!1})};t.labels=function(){t.loading=!0;r.labels(t.order.Payment.Links[0].Link).success(function(n){t.loading=!1;window.location="data:image/png;base64,"+n.Base64EncodedLabels[0]})}}]);