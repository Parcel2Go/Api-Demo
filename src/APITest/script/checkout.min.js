var p2gDelivery=function(){var n=function(){return new Promise(function(n){$("#"+window.p2gConfig.RenderId).html("<span>Loading...<\/span><br />");var t=$("<img />").attr("src","http://cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.16.1/images/loader-large.gif").attr("width","32");$("#"+window.p2gConfig.RenderId).append(t);n()})},t=function(){return new Promise(function(n,t){var r,i;try{for(console.log("Validation P2G Configuration Settings"),window.p2gConfig||t("Unable to find p2g config settings."),window.p2gConfig.RenderId&&document.getElementById(window.p2gConfig.RenderId)||t("Unable to find element to render into."),window.p2gConfig.OutputId&&document.getElementById(window.p2gConfig.OutputId)||t("Unable to find element to output to."),window.p2gConfig.Token||t("No authentication token provided."),window.p2gConfig.Parcels||t("No parcel details provided"),window.p2gConfig.Parcels.CollectionAddress&&window.p2gConfig.Parcels.CollectionAddress.Country&&window.p2gConfig.Parcels.CollectionAddress.Country||t("Invalid collection address details"),window.p2gConfig.Parcels.DeliveryAddress&&window.p2gConfig.Parcels.DeliveryAddress.Country&&window.p2gConfig.Parcels.DeliveryAddress.Country||t("Invalid delivery address details"),(!window.p2gConfig.Parcels.Parcels||window.p2gConfig.Parcels.Parcels.length<=0)&&t("No parcel data provided"),r=0;r<window.p2gConfig.Parcels.Parcels.length;r++)i=window.p2gConfig.Parcels.Parcels[r],(!i.Weight||isNaN(i.Weight))&&t("Parcel has invalid weight"),(!i.Height||isNaN(i.Height))&&t("Parcel has invalid height"),(!i.Width||isNaN(i.Width))&&t("Parcel has invalid width"),(!i.Length||isNaN(i.Length))&&t("Parcel has invalid length");n()}catch(u){throw new Error("Unable to validate configuration settings",u);}})},i=function(){return new Promise(function(n,t){console.log("Getting Quote");window.p2gConfig.Insured&&(window.p2gConfig.Parcels.Extras=["Cover"]);$.ajax({url:"https://www.parcel2go.com/api/quotes",headers:{Authorization:"Bearer "+window.p2gConfig.Token},method:"POST",data:window.p2gConfig.Parcels,success:function(t){n(t)},error:function(){t()}})})},r=function(n){return new Promise(function(t){var f,r,e,u,o,h,a,l,c,s,i;for(console.log("Processing Quotes"),f=[],i=0;i<n.Quotes.length;i++){if(r=n.Quotes[i],window.p2gConfig.Couriers&&window.p2gConfig.Couriers.length>0){for(e=!0,u=0;u<window.p2gConfig.Couriers.length;u++)if(window.p2gConfig.Couriers[u]===r.Service.CourierName){e=!1;break}if(e)continue}if(window.p2gConfig.Types&&window.p2gConfig.Types.length>0){for(e=!0,u=0;u<window.p2gConfig.Types.length;u++)if(window.p2gConfig.Types[u]===r.Service.CollectionType){e=!1;break}if(e)continue}o=r.TotalPrice;window.p2gConfig.Contribution&&!isNaN(window.p2gConfig.Contribution)&&(o=o-window.p2gConfig.Contribution,o<0&&(o=0));h=new Date(r.EstimatedDeliveryDate);h&&(a=Math.abs(h.getTime()-(new Date).getTime()),h=Math.ceil(a/864e5));f.push({courier:r.Service.CourierName,name:r.Service.Name,price:o,slug:r.Service.Slug,days:h,quote:r})}for(l=[],c=1;c<10;c++){for(s=undefined,i=0;i<f.length;i++)f[i].days===c&&(!s||s.price>f[i].price)&&(s=f[i]);s&&l.push(s)}t(l)})},u=function(n){return new Promise(function(t){var r,f,i,u;for(console.log("Rendering output"),r=$("<select><\/select>").addClass("form-control").append("<option val>Please select...<\/option>"),f=0;f<n.length;f++)i=n[f],u=$("<option><\/option>"),u.val(i.slug),u.text(i.days+" day(s) - "+i.courier+" Â£"+i.price.toFixed(2)),u.data("quote",i),r.append(u);r.change(function(){var t=$("option:selected",r),n=t.data("quote");$("#"+window.p2gConfig.OutputId).val(n.slug);window.p2gConfig.Update&&window.p2gConfig.Update(n)});$("#"+window.p2gConfig.RenderId).html("");$("#"+window.p2gConfig.RenderId).append(r);t()})},f=function(){console.log("Starting P2G Delivery Manager");t().then(n).then(i).then(r).then(u).catch(function(n){console.log("Failed to start P2G",n)})};$(function(){f()})}();